<!DOCTYPE html> <html prefix="og: http://ogp.me/ns#" lang="ru"> <head> <meta charset="utf-8" /> <meta http-equiv="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" /> <title>Выполнение JavaScript в WebView Xamarin Forms - YP Tech Notes</title> <meta name="description" content="В существующем элементе WebView имеется функция для выполнения JavaScript кода после загрузки страницы, однако она не позволяет получить результат выполнения..." /> <meta name="keywords" content="xamarin forms, javascript, c#, перевод" /> <meta name="author" content="Yauheni Pakala"> <meta property="og:title" content="Выполнение JavaScript в WebView Xamarin Forms - YP Tech Notes" /> <meta property="og:description" content="В существующем элементе WebView имеется функция для выполнения JavaScript кода после загрузки страницы, однако она не позволяет получить результат выполнения..." /> <meta property="og:url" content="https://wcoder.github.io/notes/xamarin-forms-webview-executing-javascript" /> <meta property="og:site_name" content="YP Tech Notes" /> <meta property="og:locale" content="ru_RU" /> <meta property="og:type" content="article" /> <meta property="article:author" content="Yauheni Pakala" /> <meta property="article:published_time" content="2017-07-02T00:50:00+03:00" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:creator" content="@yauhenipakala" /> <meta name='yandex-verification' content='7cd440e16ce6e1c3' /> <link rel="icon" type="image/x-icon" href="/images/favicon.ico" /> <link rel="stylesheet" href="/css/main.css" /> <link rel="stylesheet" href="/css/github.min.css" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="YP Tech Notes" /> <meta name="apple-mobile-web-app-title" content="YP Tech Notes" /> <meta name="theme-color" content="#333" /> <meta name="msapplication-navbutton-color" content="#333" /> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /> <meta name="msapplication-starturl" content="/" /> <link rel="manifest" href="/api/manifest.json" /> <link rel="canonical" href="https://wcoder.github.io/notes/xamarin-forms-webview-executing-javascript" /> <link rel="alternate" type="application/atom+xml" title="YP Tech Notes" href="https://wcoder.github.io/atom.xml" /> </head> <body> <header class="site-header"><div class="wrapper"> <a class="site-title" href="/" title="Перейти на главную">Tech Notes</a> <nav class="site-nav"> <a href="#" class="menu-icon" title="Развернуть меню"> <svg xmlns="http://www.w3.org/2000/svg" height="29" viewBox="0 0 48 48" width="48"><path d="M0 0h48v48h-48z" fill="none"></path><path d="M6 36h36v-4h-36v4zm0-10h36v-4h-36v4zm0-14v4h36v-4h-36z"></path> </svg> </a><div class="trigger"> <a class="page-link" href="https://ypakala.com/">Об авторе</a> <a class="page-link" href="/archive/">Архив</a> <a class="page-link" href="/search/">Поиск</a> <a class="page-link" href="/atom.xml"><i class="fa fa-rss"></i> RSS</a></div></nav></div></header><div class="page-content"><div class="wrapper"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"><h1 class="post-title" itemprop="name headline">Выполнение JavaScript в WebView Xamarin Forms</h1><p class="post-meta"> <time datetime="2017-07-02T00:50:00+03:00" itemprop="datePublished">02.07.2017 в 00:50</time></p></header><div class="post-content" itemprop="articleBody"><p>В существующем элементе WebView имеется функция для выполнения JavaScript кода после загрузки страницы, однако она не позволяет получить результат выполнения. В этой статье мы реализуем эту возможность через связываемое свойство (BindableProperty).</p><h2 id="расширяем-webview">Расширяем WebView</h2><p>Создадим наследника класса WebView и добавим к нему функцию <code>EvaluateJavascript</code>, которая будет принимать строку для выполнения и возвращать строку с результатом.</p><pre><code class="language-csharp">public class WebViewer : WebView
{
    public static BindableProperty EvaluateJavascriptProperty =
    BindableProperty.Create(nameof(EvaluateJavascript), typeof(Func&lt;string, Task&lt;string&gt;&gt;), typeof(WebViewer), null, BindingMode.OneWayToSource);

    public Func&lt;string, Task&lt;string&gt;&gt; EvaluateJavascript
    {
        get { return (Func&lt;string, Task&lt;string&gt;&gt;)GetValue(EvaluateJavascriptProperty); }
        set { SetValue(EvaluateJavascriptProperty, value); }
    }
}
</code></pre><h2 id="рендереры">Рендереры</h2><p>Теперь нам нужно добавить кастомный рендерер для каждой платформы, чтобы реализовать новую функцию.</p><h3 id="android">Android</h3><pre><code class="language-csharp">[assembly: ExportRenderer(typeof(WebViewer), typeof(WebViewRender))]
namespace Mobile.Droid
{
    public class WebViewRender : WebViewRenderer
    {
        protected override void OnElementChanged(ElementChangedEventArgs&lt;Xamarin.Forms.WebView&gt; e)
        {
            base.OnElementChanged(e);

            var webView = e.NewElement as WebViewer;
            if (webView != null)
                webView.EvaluateJavascript = async (js) =&gt;
                {
                    var reset = new ManualResetEvent(false);
                    var response = string.Empty;
                    Device.BeginInvokeOnMainThread(() =&gt;
                    {
                        Control?.EvaluateJavascript(js, new JavascriptCallback((r) =&gt; { response = r; reset.Set(); }));
                    });
                    await Task.Run(() =&gt; { reset.WaitOne(); });
                    return response;
                };
        }
    }

    internal class JavascriptCallback : Java.Lang.Object, IValueCallback
    {
        public JavascriptCallback(Action&lt;string&gt; callback)
        {
            _callback = callback;
        }

        private Action&lt;string&gt; _callback;
        public void OnReceiveValue(Java.Lang.Object value)
        {
            _callback?.Invoke(Convert.ToString(value));
        }
    }
}
</code></pre><h3 id="ios">iOS</h3><pre><code class="language-csharp">[assembly: ExportRenderer(typeof(WebViewer), typeof(WebViewRender))]
namespace Mobile.iOS
{
    public class WebViewRender : WebViewRenderer
    {
        protected override void OnElementChanged(VisualElementChangedEventArgs e)
        {
            base.OnElementChanged(e);

            var webView = e.NewElement as WebViewer;
            if (webView != null)
                webView.EvaluateJavascript = (js) =&gt;
                {
                    return Task.FromResult(this.EvaluateJavascript(js));
                };
        }
    }
}
</code></pre><h3 id="uwp">UWP</h3><pre><code class="language-csharp">[assembly: ExportRenderer(typeof(WebViewer), typeof(WebViewRender))]
namespace Mobile.UWP.CustomRenderers
{
    public class WebViewRender : WebViewRenderer
    {
        protected async override void OnElementChanged(ElementChangedEventArgs&lt;WebView&gt; e)
        {
            base.OnElementChanged(e);
            var webView = e.NewElement as WebViewer;
            if (webView != null)
                webView.EvaluateJavascript = async (js) =&gt;
                {
                    return await Control.InvokeScriptAsync("eval", new[] { js });
                };
        }
    }
}
</code></pre><h2 id="вызов-из-модели-представления">Вызов из модели представления</h2><p>Первым делом, нам нужно создать свойство в нашей модели представления (ViewModel), как показано ниже.</p><pre><code class="language-csharp">private Func&lt;string, Task&lt;string&gt;&gt; _evaluateJavascript;
public Func&lt;string, Task&lt;string&gt;&gt; EvaluateJavascript
{
    get { return _evaluateJavascript; }
    set { _evaluateJavascript = value; }
}
</code></pre><p>Далее, нужно связать свойство из модели представления с элементом управления (контролом).</p><pre><code class="language-xml">&lt;control:WebViewer Source="{Binding WebViewSource}"
                   EvaluateJavascript="{Binding EvaluateJavascript}, Mode=OneWayToSource}" /&gt;
</code></pre><p>Теперь мы можем вызвать нашу функцию из модели представления и получить результат.</p><pre><code class="language-csharp">var result = await EvaluateJavascript("document.getElementById('test');");
</code></pre><h2 id="предупреждения">Предупреждения</h2><p>Есть большая ловушка, с которой вы можете столкнуться, выполнение JavaScript, которое придется принять к сведению.</p><h3 id="android-1">Android</h3><p>В Android версии 4.1 и ниже вы можете легко использовать этот JavaScrip и возвращать результат.</p><pre><code class="language-js">document.getElementById('myElement').value;
</code></pre><p>Но, в версии 4.2 изменен JavsScript движок, поэтому когда вы запускаете указанный выше код, он сначала возвращает правильный результат, а потом устанавливает весь объект из DOM в результат выполнения этого сценария. Теперь, если вы снова выполните код выше, ваш скрипт не сможет найти элемент, потому что он больше не существует, т.к. весь ваш DOM - это прошлый результат.</p><p>Чтобы обойти эту проблему, вы должны присвоить результат вашего скрипта переменной. Вам не нужно возвращать значение самой переменной, достаточно просто установить ей значение, и оно будет возвращено, не затрагивая DOM существующей страницы.</p><pre><code class="language-js">var x = document.getElementById('myElement').value;
</code></pre><p><a href="https://xamarinhelp.com/xamarin-forms-webview-executing-javascript/" name="original">Оригинал</a></p><p>Теги: <a href="/tags/#xamarin+forms">xamarin forms</a>, <a href="/tags/#javascript">javascript</a>, <a href="/tags/#c%23">c#</a>, <a href="/tags/#%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4">перевод</a></p><p class="edit-post-btn"> <!--noindex--><a href="https://github.com/wcoder/wcoder.github.io/edit/master/_posts/2017-07-02-xamarin-forms-webview-executing-javascript.md" rel="nofollow" title="Редактировать страницу на GitHub">Редактировать</a><!--/noindex--></p><div class="share-btn"> <a class="btn-vk" data-id="vk" title="VK"><img alt="VK" width="16" src="/images/vk.svg" /></a> <a class="btn-facebook" data-id="fb" title="Facebook"><img alt="Facebook" width="16" src="/images/facebook.svg" /></a> <a class="btn-twitter" data-id="tw" title="Twitter"><img alt="Twitter" width="16" src="/images/twitter.svg" /></a> <a class="btn-telegram" data-id="tg" title="Telegram"><img alt="Telegram" width="16" src="/images/telegram.svg" /></a> <a class="btn-mail" data-id="mail" title="Email"><img alt="Email" width="16" src="/images/mail.svg" /></a></div></div></article></div></div><hr /><div class="wrapper"> <footer class="footer"><p class="copyrights"> &copy; 2014&ndash;<span itemprop="copyrightYear">2025</span></p><p xmlns:cc="http://creativecommons.org/ns#" class="license"> <a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" title="This work is licensed under CC BY-SA 4.0"> <img style="height:20px!important;" src="https://licensebuttons.net/l/by-sa/4.0/88x31.png" alt="CC BY-SA 4.0"> </a></p></footer></div><script src="/js/highlight.pack.js"></script> <script src="/js/highlightjs-line-numbers.min.js"></script> <script> hljs.initHighlightingOnLoad(); hljs.initLineNumbersOnLoad(); </script> <script src="/js/share-buttons.js"></script> <!--Generated with Jekyll at Nov. 11, 2025 11:59:43 AM (+03)--> </body> </html>
