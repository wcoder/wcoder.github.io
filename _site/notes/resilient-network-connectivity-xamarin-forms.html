<!DOCTYPE html> <html prefix="og: http://ogp.me/ns#" lang="ru"> <head> <meta charset="utf-8" /> <meta http-equiv="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" /> <title>Отказоустойчивое подключение к сети в Xamarin.Forms & MAUI - YP Tech Notes</title> <meta name="description" content="Мобильные сети относятся к наименее надежному типу сетей, и вашему приложению, скорее всего, придется общаться через нее, чтобы функционировать. Но, принимая..." /> <meta name="keywords" content="xamarin, xamarin forms, MAUI, перевод" /> <meta name="author" content="Yauheni Pakala"> <meta property="og:title" content="Отказоустойчивое подключение к сети в Xamarin.Forms & MAUI - YP Tech Notes" /> <meta property="og:description" content="Мобильные сети относятся к наименее надежному типу сетей, и вашему приложению, скорее всего, придется общаться через нее, чтобы функционировать. Но, принимая..." /> <meta property="og:url" content="https://wcoder.github.io/notes/resilient-network-connectivity-xamarin-forms" /> <meta property="og:site_name" content="YP Tech Notes" /> <meta property="og:locale" content="ru_RU" /> <meta property="og:type" content="article" /> <meta property="article:author" content="Yauheni Pakala" /> <meta property="article:published_time" content="2018-03-17T18:25:00+03:00" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:creator" content="@yauhenipakala" /> <meta name='yandex-verification' content='7cd440e16ce6e1c3' /> <link rel="icon" type="image/x-icon" href="/images/favicon.ico" /> <link rel="stylesheet" href="/css/main.css" /> <link rel="stylesheet" href="/css/github.min.css" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="YP Tech Notes" /> <meta name="apple-mobile-web-app-title" content="YP Tech Notes" /> <meta name="theme-color" content="#333" /> <meta name="msapplication-navbutton-color" content="#333" /> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /> <meta name="msapplication-starturl" content="/" /> <link rel="manifest" href="/api/manifest.json" /> <link rel="canonical" href="https://wcoder.github.io/notes/resilient-network-connectivity-xamarin-forms" /> <link rel="alternate" type="application/atom+xml" title="YP Tech Notes" href="https://wcoder.github.io/atom.xml" /> </head> <body> <header class="site-header"><div class="wrapper"> <a class="site-title" href="/" title="Перейти на главную">Tech Notes</a> <nav class="site-nav"> <a href="#" class="menu-icon" title="Развернуть меню"> <svg xmlns="http://www.w3.org/2000/svg" height="29" viewBox="0 0 48 48" width="48"><path d="M0 0h48v48h-48z" fill="none"></path><path d="M6 36h36v-4h-36v4zm0-10h36v-4h-36v4zm0-14v4h36v-4h-36z"></path> </svg> </a><div class="trigger"> <a class="page-link" href="https://ypakala.com/">Об авторе</a> <a class="page-link" href="/archive/">Архив</a> <a class="page-link" href="/search/">Поиск</a> <a class="page-link" href="/atom.xml"><i class="fa fa-rss"></i> RSS</a></div></nav></div></header><div class="page-content"><div class="wrapper"> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"><h1 class="post-title" itemprop="name headline">Отказоустойчивое подключение к сети в Xamarin.Forms & MAUI</h1><p class="post-meta"> <time datetime="2018-03-17T18:25:00+03:00" itemprop="datePublished">17.03.2018 в 18:25</time></p></header><div class="post-content" itemprop="articleBody"><p>Мобильные сети относятся к наименее надежному типу сетей, и вашему приложению, скорее всего, придется общаться через нее, чтобы функционировать. Но, принимая во внимание потенциальность сбоев, мы должны обеспечить наше приложение возможностью приспосабливаться к плохому состоянию сети.</p><p><img src="https://xamarinhelp.com/wp-content/uploads/2018/02/cell_network.png" alt="Сеть" /></p><h2 id="httpclient">HttpClient</h2><p>В большинстве случаев вы будете подключаться к API через <code>HttpClient</code>, как здесь:</p><pre><code class="language-csharp">public class MyApiClass
{
    public readonly HttpClient _client;

    public MyApiClass()
    {
        _client = new HttpClient();
        _client.DefaultRequestHeaders.Accept.Clear();
        // Предполагая, что вы подключаетесь к REST API, который принимает JSON
        _client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
    }

    public async Task GetAsync()
    {
        var result = await _client.GetAsync("https://someurl.com/product/1");
    }

    public async Task SendAsync()
    {
        var product = new Product { Name = "New Product" };

        var json = JsonConvert.SerializeObject(product);

        var result = await _client.SendAsync(new HttpRequestMessage()
        {
            RequestUri = new Uri("https://someurl.com/product"),
            Content = new StringContent(json)
        });
    }
}
</code></pre><blockquote><p><strong>Совет:</strong> Не использовать оператор <code>using</code> для <code>HttpClient</code>, хранить только один экземпляр для всего приложения. Он был разработан, чтобы работать таким образом.</p></blockquote><p>Есть множество мест, где мы можем потерпеть неудачу.</p><ul> <li><code>GetAsync</code>:<ul> <li><code>ArgumentNullException</code> - запрос был пустым;</li> <li><code>HttpRequestException</code> - базовая сеть каким-то образом отказала;</li> <li><code>InvalidOperationException</code> - сообщение уже выло отправлено.</li></ul></li></ul><p>Поэтому вы хотели бы обернуть вызовы, чтобы перехватить эти ошибки и разобраться с ними по мере необходимости. Но, допустим ошибки нет, теперь нам нужно проверить возвращаемый код состояния:</p><pre><code class="language-csharp">public async Task GetAsync()
{
    var result = await _client.GetAsync("https://someurl.com/product/1");

    if (result.IsSuccessStatusCode)
    {
        // Успех
    }
    else
    {
        // Возвращен код, отличный от 200
    }
}
</code></pre><p>Если код возвращается, хорошо, вы можете продолжать. Если это не так, то вы должны что-то с этим сделать. 400-е ошибки - это про то, что вы отправили неверный запрос к API, 500-е ошибки означают, что обратиться к API не удалось (ошибка на сервере).</p><h2 id="проверка-подключения">Проверка подключения</h2><p>Возможно, ваша страница имеет много сетевых вызовов. Поэтому, возможно, вы захотите сделать проверку что сетевое подключение есть, перед тем как пытаться делать запрос. Вы можете сделать это с помощью плагина <a href="https://github.com/jamesmontemagno/ConnectivityPlugin">Xam.Plugin.Connectivity</a>. Проверить подключение можно так:</p><pre><code class="language-csharp">CrossConnectivity.Current.IsConnected
</code></pre><p>Если значение <code>false</code> вам не нужно делать сетевые вызовы. Если значение <code>true</code>, то сеть может пропасть уже при выполнении следующей строки кода, в результате чего возникнет <code>HttpRequestException</code>.</p><h2 id="повторное-выполнение">Повторное выполнение</h2><p>Если у вас есть проблемы с подключением, вы, возможно, захотите повторить запрос, если это был всего лишь кратковременный сбой. Вы можете сделать это с помощью <a href="https://github.com/App-vNext/Polly">Polly</a>. Здесь снова тот же метод <code>GetAsync</code>, но на этот раз он будет повторяться до трех раз, с двух секундной паузой между запросами, если возникает <code>HttpRequestException</code>. Вы также можете добавить дополнительные исключения, при которых нужна повторная попытка.</p><pre><code class="language-csharp">public async Task GetAsync()
{
    var result = await Policy
            .Handle&lt;HttpRequestException&gt;()
            .WaitAndRetry(
                retryCount: 3,
                sleepDurationProvider: (attempt) =&gt; TimeSpan.FromSeconds(2))
            .ExecuteAsync(async () =&gt; await _client.GetAsync("https://someurl.com/product/1"));

    if (result.IsSuccessStatusCode) { } // Успех
    else { } // Возвращен код, отличный от 200
}
</code></pre><h2 id="выводы">Выводы</h2><p>Лучший способ избежать проблем с подключением - не делать сетевые вызовы. Если вашему приложению все же нужно ходить в сеть, можно уменьшить число возможных вызовов, реализовав кэширование.</p><p>Если вы используете <code>HttpClient</code> + <a href="https://github.com/paulcbetts/refit">Refit</a> (для упрощения вызовов к API) убедитесь, что используете связку правильно.</p><p>Убедившись, что вы проверяете возможность подключения, проверьте наличие исключений и, возможно, повторите попытку. Затем проверьте коды состояния.</p><p>Теперь вы можете легко заставить приложение работать с ненадежной сетью.</p><p><a href="https://xamarinhelp.com/resilient-network-connectivity-xamarin-forms/" name="original">Оригинал</a></p><p>Теги: <a href="/tags/#xamarin">xamarin</a>, <a href="/tags/#xamarin+forms">xamarin forms</a>, <a href="/tags/#MAUI">MAUI</a>, <a href="/tags/#%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4">перевод</a></p><p class="edit-post-btn"> <!--noindex--><a href="https://github.com/wcoder/wcoder.github.io/edit/master/_posts/2018-03-17-resilient-network-connectivity-xamarin-forms.md" rel="nofollow" title="Редактировать страницу на GitHub">Редактировать</a><!--/noindex--></p><div class="share-btn"> <a class="btn-vk" data-id="vk" title="VK"><img alt="VK" width="16" src="/images/vk.svg" /></a> <a class="btn-facebook" data-id="fb" title="Facebook"><img alt="Facebook" width="16" src="/images/facebook.svg" /></a> <a class="btn-twitter" data-id="tw" title="Twitter"><img alt="Twitter" width="16" src="/images/twitter.svg" /></a> <a class="btn-telegram" data-id="tg" title="Telegram"><img alt="Telegram" width="16" src="/images/telegram.svg" /></a> <a class="btn-mail" data-id="mail" title="Email"><img alt="Email" width="16" src="/images/mail.svg" /></a></div></div></article></div></div><hr /><div class="wrapper"> <footer class="footer"><p class="copyrights"> &copy; 2014&ndash;<span itemprop="copyrightYear">2025</span></p><p xmlns:cc="http://creativecommons.org/ns#" class="license"> <a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" title="This work is licensed under CC BY-SA 4.0"> <img style="height:20px!important;" src="https://licensebuttons.net/l/by-sa/4.0/88x31.png" alt="CC BY-SA 4.0"> </a></p></footer></div><script src="/js/highlight.pack.js"></script> <script src="/js/highlightjs-line-numbers.min.js"></script> <script> hljs.initHighlightingOnLoad(); hljs.initLineNumbersOnLoad(); </script> <script src="/js/share-buttons.js"></script> <!--Generated with Jekyll at Nov. 11, 2025 11:59:43 AM (+03)--> </body> </html>
